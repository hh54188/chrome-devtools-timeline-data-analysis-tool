<!DOCTYPE html>
<html>
<head>
    <title></title>
    <!-- Style -->
    <link rel="stylesheet" type="text/css" href="css/style.css">
    <link rel="stylesheet" type="text/css" href="bootstrap/css/bootstrap-theme.min.css">
    <link rel="stylesheet" type="text/css" href="bootstrap/css/bootstrap.min.css">
    <!-- APP -->
    <script type="text/javascript" src="js/data.js"></script>
    <script type="text/javascript" src="js/filter.js"></script>
    <script type="text/javascript" src="js/grid.js"></script>    
</head>
<body>
    <div class="container">
        <h1>Chrome devtools Timeline Data Analysis Tool</h1>
        <hr>
        <div id="drop_zone">Drop TimelineRawData.json file here</div>
        <div id="backgrid-container"></div>
    </div>
    <script type="text/javascript">
    var Data 
    var DataByCategory = {};
    var DataByUrl = {};

    var endTimeStack = [];
    var urlStack = [];

    function sortCategoryByTimecost(data) {
        var toArray = [], result = [];
        for (var name in data) {
            toArray.push({
                type: name,
                data: data[name]
            });
        }

        toArray.forEach(function (item) {

            result.push(item);
            if (result.length == 1 ) return;

            var cur = result.length - 1, prev = cur - 1;
            var temp;

            while (result[cur].data.total_cost > result[prev].data.total_cost) {

                temp = result[prev];
                result[prev] = result[cur];
                result[cur] = temp;

                prev = (--cur) - 1;
                if (prev < 0) return;
            }
        });

        return result;
    }

    function resolveFile(dataArr) {

        if (typeof dataArr[0] == "string") {
            dataArr.splice(0, 1);
        }

        (function _resolve(arr) {
            var _data;

            arr.forEach(function (item) {

                if (!item.endTime) {
                    item.endTime = endTimeStack[endTimeStack.length - 1];
                }
                endTimeStack.push(item.endTime);


                if (!item.data.url) {
                    item.data.url = urlStack[urlStack.length - 1];
                }
                urlStack.push(item.data.url);

                // Category by type(Layout, parseHtml, etc)
                if (item.type) {
                    if (!(_data = DataByCategory[item.type])) {
                        DataByCategory[item.type] = new Data();
                    } else {
                        _data.add(item);
                    }
                }

                // Category by url
                if (item.data.url) {
                    if (!(_data = DataByUrl[item.data.url])) {
                        DataByUrl[item.data.url] = new Data();
                    } else {
                        _data.add(item);
                    }
                } else {

                    if (!DataByUrl["without"]) DataByUrl["without"] = new Data();
                    DataByUrl["without"].add(item);
                }

                if (item.children && item.children.length) {
                    _resolve(item.children);
                }

                urlStack.pop();
                endTimeStack.pop();
            });

        })(dataArr);

        /*---------------RESOLVE COMPLETE------------*/

        console.log(sortCategoryByTimecost(DataByCategory));
        console.log(sortCategoryByTimecost(DataByUrl));
        // var sortArr = sortCategoryByTimecost(DataByCategory);
        // var sortArr = sortCategoryByTimecost(DataByUrl);
        // sortArr.forEach(function (item) {
        //     console.log(item.type, item.data.total_cost);
        // })
    }

    function readFile(file) {
        var reader = new FileReader();
        reader.onload = function(e) {
            var result = e.target.result;
            try {
                resolveFile(JSON.parse(result));
            } catch(err) {
                console.log(err);
            }
            
        };

        reader.readAsText(file);
    }

    function handleDragOver(evt) {

        evt.stopPropagation();
        evt.preventDefault();

        evt.dataTransfer.dropEffect = 'copy';
    }    

    function handleFileSelect(evt) {
        evt.stopPropagation();
        evt.preventDefault();

        var files = evt.target.files || evt.dataTransfer.files;
        var output = [];

        for (var i = 0, f; f = files[i]; i++) {
            readFile(f);
        }
    }


    var dropZone = document.getElementById('drop_zone');
    dropZone.addEventListener('dragover', handleDragOver, false);
    dropZone.addEventListener('drop', handleFileSelect, false);

    </script>
</body>
</html>