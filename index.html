<!DOCTYPE html>
<html>
<head>
    <title></title>
    <!-- Style -->
    <link rel="stylesheet" type="text/css" href="css/style.css">
    <link rel="stylesheet" type="text/css" href="bootstrap/css/bootstrap-theme.min.css">
    <link rel="stylesheet" type="text/css" href="bootstrap/css/bootstrap.min.css">
    <!-- APP -->
    <script type="text/javascript" src="js/data.js"></script>
    <script type="text/javascript" src="js/filter.js"></script>
    <script type="text/javascript" src="js/grid.js"></script>    
</head>
<body>
    <div class="container">
        <h1>Chrome devtools Timeline Data Analysis Tool</h1>
        <hr>
        <div id="drop_zone">Drop TimelineRawData.json file here</div>
        <div id="backgrid-container"></div>
    </div>
    <script type="text/javascript">

    var DataByCategory = {};
    var DataByScript = {};
    var endTimeStack = [];
    var urlStack = [];

    function testIfHaveURL(data) {

        for (var key in data) {
            console.log("CATEGORY------>", key);
            var d = data[key].sorted_data;

            d.forEach(function (item) {
                if (item.data && (item.data.url || item.data.uri)) {
                    console.dir(item.data);
                }
            })
        }
    }

    function resolveFile(dataArr) {
        console.log("Origin Data----->", dataArr);
        if (typeof dataArr[0] == "string") {
            dataArr.splice(0, 1);
        }

        (function _resolve(arr) {
            var _data;

            arr.forEach(function (item) {

                if (item.endTime) {
                    endTimeStack.push(item.endTime);
                } else {
                    item.parentEndTime = endTimeStack[endTimeStack.length - 1];
                }

                if (item.data.url) {
                    urlStack.push(item.data.url);
                } else {
                    item.data.url = urlStack[urlStack.length - 1];
                }

                if (item.type) {

                    if (!(_data = DataByCategory[item.type])) {
                        DataByCategory[item.type] = new Data();
                    } else {
                        _data.add(item);
                    }
                }

                if (item.children && item.children.length) {
                    _resolve(item.children);
                }


                if (item.data.url) {
                    urlStack.pop();
                }

                if (item.endTime) {
                    endTimeStack.pop();
                }
            });

        })(dataArr);

        // console.log("DataByCategory------>", DataByCategory);
        testIfHaveURL(DataByCategory);
    }

    function readFile(file) {
        var reader = new FileReader();
        reader.onload = function(e) {
            var result = e.target.result;
            try {
                resolveFile(JSON.parse(result));
            } catch(err) {
                console.log(err);
            }
            
        };

        reader.readAsText(file);
    }

    function handleDragOver(evt) {

        evt.stopPropagation();
        evt.preventDefault();

        evt.dataTransfer.dropEffect = 'copy';
    }    

    function handleFileSelect(evt) {
        evt.stopPropagation();
        evt.preventDefault();

        var files = evt.target.files || evt.dataTransfer.files;
        var output = [];

        for (var i = 0, f; f = files[i]; i++) {
            readFile(f);
        }
    }


    var dropZone = document.getElementById('drop_zone');
    dropZone.addEventListener('dragover', handleDragOver, false);
    dropZone.addEventListener('drop', handleFileSelect, false);

    </script>
</body>
</html>